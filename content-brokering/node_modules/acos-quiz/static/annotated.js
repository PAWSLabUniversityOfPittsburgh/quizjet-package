$(function() {
    $('.annotated-example').each(function() {
        var element = $(this);
        var id = element.attr('data-id');
        
        var data = window.annotated;
        
        if (data[id]) {
            var counter = 0;
            ACOS.sendEvent('line', 0);

            sub = '&sub=0';
            _url = location.href;
            _url += (_url.split('?')[1] ? '&':'?');
            if (_url.substring(_url.length-1) == "&")
            {
                _url = _url.substring(0, _url.length-1);
            }
            window.history.replaceState({}, '', _url+sub);
            
            $('<div></div>').appendTo(element).addClass('annotated-description').text(data[id].description);

            //This is the place to pass the link and its associated URL parameters to the UM
            //Passing the parameters will help track the line clicks and line recommendation feature
            //Should be of the form:
            //“SERVER_URL?usr=“ + req_user + “&sid=“ + req_session + “&app=3&act=“ + [example rdf id] + “&sub=“ + [line number] + “&res=-1&grp=“ + req_group + “&svc=“ + “[dummy_SVC]”;

            data[id].lines.forEach(function(line) {
                var lineDiv = $('<div></div>').appendTo(element).attr('data-line', ++counter);                
                var toggleDiv = $('<div></div>').addClass('annotated-line-toggle').appendTo(lineDiv);
                
                if (line.comment) {
                    $('<div></div>').appendTo(toggleDiv).text('+').attr('data-line', counter).click(function(e) {
                        e.preventDefault();
                        var button = $(this);
                        element.find('.annotated-comment[data-line!="' + $(this).attr('data-line') + '"]').hide();
                        element.find('.annotated-line-toggle div').text('+');
                        var commentDiv = element.find('.annotated-comment[data-line="' + $(this).attr('data-line') + '"]');
                        commentDiv.toggle(300, function() {
                            if (commentDiv.is(':visible')) {
                                button.text('-');
                                if (window.ACOS) {
                                    ACOS.sendEvent('line', $(this).attr('data-line'));


                                    sub = '&sub='+$(this).attr('data-line');
                                    _url = location.href;
                                    _url += (_url.split('?')[1] ? '&':'?');
                                    if (_url.indexOf('&sub') > -1){
                                        console.log('into if');
                                        _url = _url.substring(0, _url.indexOf('&sub'));
                                        window.history.replaceState(null, null, _url+sub);
                                    }
                                    else{
                                        console.log(_url);
                                        if (_url.substring(_url.length-1) == "&")
                                        {
                                            _url = _url.substring(0, _url.length-1);
                                        }
                                        console.log('into else');
                                        window.history.replaceState({}, '', _url+sub);
                                    }

                                    /*
                                    addParameterToURL(sub);
                                    function addParameterToURL(sub){
                                        _url = location.href;
                                        _url += (_url.split('?')[1] ? '&':'?') + sub;
                                        console.log(_url)
                                        //location.hash = sub.replace('#','');
                                        //window.history.replaceState({}, "Title", _url);
                                    }
                                    */

                                    //ACOS.sendEvent('log', {exampleId: id, type: 'open', line: $(this).attr('data-line')});
                                }
                            }
                            
                        });
                    });
                    lineDiv.after($('<div></div>').addClass('annotated-comment').text(line.comment).attr('data-line', counter).hide());
                }
                
                $('<div></div>').addClass('annotated-line-number').text(counter).appendTo(lineDiv);
                $('<div></div>').addClass('annotated-line-code').text(line.line).appendTo(lineDiv);
                
            });
        }
    });
});